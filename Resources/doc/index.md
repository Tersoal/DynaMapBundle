Getting started with Dyna Map Bundle
====================================

The DynaMap Bundle require some configuration and some entities in your application.

## Installation

You can install Dyna Map Bundle through [Composer](https://getcomposer.org):

```shell
$ composer require tersoal/dynamap
```

Or adding the bundle to your composer.json:

```php
{
    "require": {
        "tersoal/dynamap": "dev-master",
    }
}
```

And update vendors:

```shell
$ composer update
```

Then, register the new vendor and Cocur Slugify in your AppKernel.php:

```php
    public function registerBundles()
    {
        $bundles = array(
            // ...
            new Cocur\Slugify\Bridge\Symfony\CocurSlugifyBundle(),
            new Tersoal\DynaMapBundle\TersoalDynaMapBundle(),
            // ...
        );
    }
```

## Configuration

There are mandatory and optional parameters to configure in config.yml:

```php
tersoal_dyna_map:
    master_entity: Tersoal\AppBundle\Entity\Project # your master entity, mandatory
    field_entity: Tersoal\AppBundle\Entity\ProjectField # your field entity, mandatory
    route_parameter: project_id # the route parameter necessary to manage dynamic entities, mandatory
    field_white_list: ~ # list of fields available, optional
    field_black_list: ~ # list of fields not available, optional
```

You can tell bundle to allow some fields only, or to disallow some of them. See the complete list of available
fields [here](available_fields.md).

Also you need provide the route parameter name which identifies your models (see below).

## Usage

The bundle needs to know how dynamic entities are managed. For that, you must follow som steps.

The entities extend another class and/or implement an interface to minimize your work with them. This allows you
to customize another information that you want to have in your application.

### 1.- Master entity

This entity contains all dynamic database tables linked with their fields. It also allow to select a certain model
for a certain table.

For example, you could have an entity to manage all your projects.

[Sample code](master_entity.md)

### 2.- Field entity

This entity contains the fields for database tables. With it you can add fields and customize some of their properties.

For example, you could have an entity to manage all your project fields.

[Sample code](field_entity.md)

### 3.- Model entities

You can have multiple models in your application, as you wish, all independent from each other.

For example, you could have a car model to manage your car projects.

[Sample code](model_entity.md)

### 4.- Routing

To identify which table you are accessing it's mandatory to add the table id to the model routing, and you must
add de routing parameter name to the bundle config.

For example, your car routing config can look like this (generated by CRUD command):

```php
<!--Tersoal/AppBundle/Resources/config/routing/car.xml-->
<?xml version="1.0" encoding="UTF-8" ?>

<routes xmlns="http://symfony.com/schema/routing"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/routing http://symfony.com/schema/routing/routing-1.0.xsd">

    <route id="car" path="/">
        <default key="_controller">TersoalAppBundle:Car:index</default>
    </route>

    <route id="car_show" path="/{id}/show">
        <default key="_controller">TersoalAppBundle:Car:show</default>
    </route>

    <route id="car_new" path="/new">
        <default key="_controller">TersoalAppBundle:Car:new</default>
    </route>

    <route id="car_create" path="/create" methods="POST">
        <default key="_controller">TersoalAppBundle:Car:create</default>
    </route>

    <route id="car_edit" path="/{id}/edit">
        <default key="_controller">TersoalAppBundle:Car:edit</default>
    </route>

    <route id="car_update" path="/{id}/update" methods="POST|PUT">
        <default key="_controller">TersoalAppBundle:Car:update</default>
    </route>

    <route id="car_delete" path="/{id}/delete" methods="POST|DELETE">
        <default key="_controller">TersoalAppBundle:Car:delete</default>
    </route>

</routes>
```

And in the routing.yml you can have this routing:

```php
# Tersoal/AppBundle/Resources/config/routing.yml
tersoal_app_car:
    resource: "@TersoalAppBundle/Resources/config/routing/car.xml"
    prefix:   /project/{project_id}/car
```

### 6.- Twig functions

There are two functions that you'll need to get dynamic fields in the model views:

### dyna_map_model_fields
This function gets all the fields objects for a given model.

For example you can show the name of the fields in the header of your index view:

```php
                {% set dynaFields = dyna_map_model_fields('car') %}
                {% for field in dynaFields %}
                    <th>{{ field.fieldName }}</th>
                {% endfor %}
```

And then you can use dynafields to call the next function.

### dyna_map_model_field_name
This function gets the field name of the entity object for a given field ID.

For example, with the previous array of fields you can do something like this:

```php
                {% for field in dynaFields %}
                    {% if field.fieldType in ['birthday', 'date', 'datetime', 'time'] %}
                        <td>{{ entity.__get(dyna_map_model_field_name(field.id)) | date("m/d/Y") }}</td>
                    {% else %}
                        <td>{{ entity.__get(dyna_map_model_field_name(field.id)) }}</td>
                    {% endif %}
                {% endfor %}
```

You must call to __get magic method (remember that we don't have methods, just properties).

In your forms, you can do something like this (simple form for car):

```php
{# Tersoal/AppBundle/Resources/views/Car/new.html.twig #}
{% extends '::base.html.twig' %}

{% block body -%}
    <h1>Car creation</h1>

    {{ form_start(form) }}

        {{ form_row(form.carName) }}
        {{ form_row(form.carComment) }}
        {{ form_row(form.note) }}
    
        {% set dynaFields = dyna_map_model_fields('coche') %}
        {% for field in dynaFields %}
            {% set fieldName = dyna_map_model_field_name(field.id) %}
            {{ form_row(attribute(form, fieldName)) }}
        {% endfor %}

    {{ form_end(form) }}
    
    <ul class="record_actions">
        <li>
            <a href="{{ path('car', { 'project_id': project_id }) }}">
                Back to the list
            </a>
        </li>
    </ul>
{% endblock %}
```

### TODO

There is a lot of work to do. This is only a base for a bigger development that I'll take on.